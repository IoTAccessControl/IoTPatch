# Zephyr MQTT Subscriber App

> **board**: NRF52840

> **host environment**: x86-64, Ubuntu 19.10

## Flash the image on the board

This prebuilt vulnerable MQTT subscriber application of Zephyr OS is integrated with RapidPatch. 

Please flash the `zephyr.bin` image to your NRF52840 board first, using JTAG SWD or any other available debug interface.


## Evaluation

We use mosquitto broker and mosquitto publisher on host machine to help evaluate the Zephyr MQTT Subscriber App on NRF52840 board.

To install mosquitto broker and client on host machine:

```
sudo apt-get update
sudo apt-get install mosquitto
sudo apt-get install mosquitto-clients
```

To run mosquitto broker on host machine:

```
sudo mosquitto -v -p 1883
```

To publish a single MQTT message on host machine:

```
sudo mosquitto_pub -t test_topic -m helloworld -p 1883
```

To batch publish MQTT messages on host machine:

```
cd IoTPatch/VulDevices/zephyr-app-mqtt
cd evaluation
python3 batch_mqtt_publish.py
```

We measure the duration between a PUBLISH message delivered by the broker and the corresponding PUBACK.

### Evaluation Steps

1. Flash Zephyr MQTT Subscriber App to NRF52840 board.

2. Connect the board and the host machine using Ethernet or WiFi.

* Notice that this image has enabled a USB-to-Ethernet driver. So if your board has a USB interface, you can establish an Ethernet connection between the board and your host machine directly with a USB cable.

3. Establish serial port connection with the board.

Once you have flashed your board, you can estabish a serial connection with your board utilizing the USB-to-UART interface and a terminal tool (e.g., PuTTY, cutecom). As the terminal tool connects successfully, reset the board, and then you can see the simple cli we provide with RapidPatch. 

```
[23:24:31:997] ***** Booting Zephyr OS zephyr-v1.14.1 *****␍␊
[23:24:34:999] IoTPatch Cli Usage: run [idx] | trigger [cve] | patch [cve] | vm [vid]␍␊
[23:24:35:005] run 0: Test FPB breakpoint add␍␊
[23:24:35:011] run 1: Test FPB patch trigger␍␊
[23:24:35:018] run 2: Clear all bpkt and patch␍␊
[23:24:35:018] run 3: Run eva test␍␊
[23:24:35:018] run 4: Start patch service␍␊
[23:24:35:026] run 5: Start testing fixed patch point␍␊
```

To minimize the evaluation efforts, we have embedded the dynamic-JIT eBPF patch code for CVE-2020-10062 in the prebuilt image. And you can trigger the patch process (install and enable the patch) by inputing to the cli:

```
patch 3
```

And you can rewind the patch through inputing (or just reseting the board):

```
run 2
```

4. Run mosquitto broker on host machine.

```
sudo mosquitto -v -p 1883
```

5. Press reset button on the NRF52840 board to rerun the MQTT Subscriber App.

6. Run the timing tool.

```
cd evaluation
python3 publish_timing.py
```

7. Run batch publish tool.

```
python3 batch_mqtt_publish.py
```

You might run this evaluation with the patch enabled or not.

Have fun!