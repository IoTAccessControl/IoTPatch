# Zephyr USB Mass Storage App

> **board**: NRF52840

> **host environment**: x86-64, Ubuntu 19.10

## Flash the image on the board

This prebuilt vulnerable USB Mass Storage application of Zephyr OS is integrated with RapidPatch. 

Please flash the `zephyr.bin` image to your NRF52840 board first, using JTAG SWD or any other available debug interface.


## Evaluation

After flashing, we connect the board to the host PC using a USB cable and now the NRF52840 board would function as a USB Mass Storage device.

We use the script, `mass_USB_perf.py` to send USB commands to the board. In detail, for each iteration of the main loop, we send several read/write commands to the board, and measure the overall delay. 

### Evaluation Steps

1. Flash Zephyr USB Mass Storage App to NRF52840 board.

2. Connect the board and the host machine using a USB cable.

3. Establish serial port connection with the board.

Once you have flashed your board, you can estabish a serial connection with your board utilizing the USB-to-UART interface and a terminal tool (e.g., PuTTY, cutecom). As the terminal tool connects successfully, reset the board, and then you can see the simple cli we provide with RapidPatch. 

```
[23:24:31:997] ***** Booting Zephyr OS zephyr-v1.14.1 *****␍␊
[23:24:34:999] IoTPatch Cli Usage: run [idx] | trigger [cve] | patch [cve] | vm [vid]␍␊
[23:24:35:005] run 0: Test FPB breakpoint add␍␊
[23:24:35:011] run 1: Test FPB patch trigger␍␊
[23:24:35:018] run 2: Clear all bpkt and patch␍␊
[23:24:35:018] run 3: Run eva test␍␊
[23:24:35:018] run 4: Start patch service␍␊
[23:24:35:026] run 5: Start testing fixed patch point␍␊
```

To minimize the evaluation efforts, we have embedded the dynamic-JIT eBPF patch code for CVE-2020-10021 in the prebuilt image. And you can trigger the patch process (install and enable the patch) by inputing to the cli:

```
patch 2
```

And you can rewind the patch through inputing (or just reseting the board):

```
run 2
```

4. Run the USB mass storage evaluation script on host machine.

```
cd evaluation
python3 mass_USB_perf.py
```

> You might have to install some dependecies in order to run this script.

You can run this evaluation with the patch enabled or not.

Have fun!
